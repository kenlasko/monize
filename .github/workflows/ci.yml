name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  backend-lint:
    name: Backend Lint & Type Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm install
      - run: npm run lint
      - run: npx tsc --noEmit

  backend-unit-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm install
      - run: npm run test:unit -- --coverage
      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-unit-coverage
          path: backend/coverage/

  backend-integration-tests:
    name: Backend Integration Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: monize_test
          POSTGRES_USER: monize_test
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    defaults:
      run:
        working-directory: backend
    env:
      DATABASE_HOST: localhost
      DATABASE_PORT: 5432
      DATABASE_NAME: monize_test
      DATABASE_USER: monize_test
      DATABASE_PASSWORD: test_password
      JWT_SECRET: test-jwt-secret-for-ci-minimum-32-characters-long
      NODE_ENV: test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm install
      - run: npm run build
      - run: npm run test:integration

  frontend-lint:
    name: Frontend Lint & Type Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm install
      - run: npm run lint
      - run: npm run type-check

  frontend-unit-tests:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm install
      - run: npm run test:cov
      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage/

  build-and-push:
    name: Build & Push Containers
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs:
      [
        backend-lint,
        backend-unit-tests,
        backend-integration-tests,
        frontend-lint,
        frontend-unit-tests,
      ]
    permissions:
      contents: write
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Bump patch version
        id: version
        run: |
          CURRENT=$(node -p "require('./backend/package.json').version")
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "Bumping version: $CURRENT -> $NEW_VERSION"
          cd backend  && npm version "$NEW_VERSION" --no-git-tag-version && cd ..
          cd frontend && npm version "$NEW_VERSION" --no-git-tag-version && cd ..

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend
        uses: docker/build-push-action@v6
        with:
          context: .
          file: backend/Dockerfile
          target: production
          push: true
          tags: |
            ghcr.io/kenlasko/monize-backend:latest
            ghcr.io/kenlasko/monize-backend:${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push frontend
        uses: docker/build-push-action@v6
        with:
          context: frontend
          file: frontend/Dockerfile
          target: production
          push: true
          tags: |
            ghcr.io/kenlasko/monize-frontend:latest
            ghcr.io/kenlasko/monize-frontend:${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add backend/package.json backend/package-lock.json frontend/package.json frontend/package-lock.json
          git commit -m "chore: bump version to ${{ steps.version.outputs.version }} [skip ci]"
          git push

  # E2E tests temporarily disabled - re-enable once tests are stabilized
  # e2e-tests:
  #   name: E2E Tests
  #   runs-on: ubuntu-latest
  #   needs: [backend-unit-tests, frontend-unit-tests]
  #   env:
  #     POSTGRES_DB: monize
  #     POSTGRES_USER: monize_user
  #     POSTGRES_PASSWORD: monize_password
  #     JWT_SECRET: test-jwt-secret-for-ci-minimum-32-characters-long
  #     NODE_ENV: development
  #     PUBLIC_APP_URL: http://localhost:3001
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-node@v4
  #       with:
  #         node-version: 20
  #     - name: Create .env for Docker Compose
  #       run: |
  #         cat > .env << 'EOF'
  #         POSTGRES_DB=monize
  #         POSTGRES_USER=monize_user
  #         POSTGRES_PASSWORD=monize_password
  #         JWT_SECRET=test-jwt-secret-for-ci-minimum-32-characters-long
  #         NODE_ENV=development
  #         PUBLIC_APP_URL=http://localhost:3001
  #         EOF
  #     - name: Start services
  #       run: |
  #         docker compose up -d --build
  #         timeout 120 bash -c 'until curl -sf http://localhost:3001; do sleep 5; done'
  #     - name: Install Playwright
  #       working-directory: e2e
  #       run: |
  #         npm install
  #         npx playwright install --with-deps chromium
  #     - name: Run E2E tests
  #       working-directory: e2e
  #       env:
  #         BASE_URL: http://localhost:3001
  #         CI: 'true'
  #       run: npx playwright test --project=chromium
  #     - name: Upload test report
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: e2e-report
  #         path: e2e/playwright-report/
  #     - name: Stop services
  #       if: always()
  #       run: docker compose down -v
